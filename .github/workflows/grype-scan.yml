name: GRYPE - Always Green Vulnerability Scan (FIXED)

on:
  push:
  pull_request:

jobs:
  grype-scan:
    runs-on: ubuntu-latest

    steps:

    # 1Ô∏è‚É£ R√©cup√©ration du code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Installation CORRIG√âE de Grype (SANS mv, SANS bug)
    - name: Install Grype (Safe Install)
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh
        echo "$PWD/bin" >> $GITHUB_PATH

    # 3Ô∏è‚É£ Scan TOTAL du d√©p√¥t + g√©n√©ration JSON + TXT
    #     La commande ne peut JAMAIS casser le pipeline
    - name: Run Grype Scan (Always Success)
      run: |
        mkdir -p reports

        echo "üîç Running Grype scan on the entire repository..."

        grype dir:. -o json > reports/grype-report.json || echo "{}" > reports/grype-report.json
        grype dir:. -o table > reports/grype-report.txt || echo "Scan failed but pipeline continues" > reports/grype-report.txt

    # 4Ô∏è‚É£ Message OBLIGATOIRE dans les logs
    - name: Display Mandatory Result Message
      run: |
        if grep -q '"vulnerabilities": \[\]' reports/grype-report.json; then
          echo "‚úÖ No Vulnerability detected"
        else
          echo "‚ö†Ô∏è Vulnerability detected"
        fi

    # 5Ô∏è‚É£ Affichage du rapport TXT dans les logs
    - name: Show TXT Report in Logs
      run: |
        echo "================= GRYPE TXT REPORT ================="
        cat reports/grype-report.txt
        echo "===================================================="

    # 6Ô∏è‚É£ Upload des rapports t√©l√©chargeables
    - name: Upload Scan Reports
      uses: actions/upload-artifact@v4
      with:
        name: grype-vulnerability-reports
        path: reports/

    # 7Ô∏è‚É£ For√ßage DUR du statut ‚úÖ VERT ‚úÖ quoi qu‚Äôil arrive
    - name: Force Green Pipeline (Final Lock)
      run: |
        echo "‚úÖ PIPELINE FORCED TO SUCCESS FOR PEDAGOGY"
        exit 0
