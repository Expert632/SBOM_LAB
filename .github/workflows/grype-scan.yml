name: GRYPE - Always Green Vulnerability Scan

on:
  push:
  pull_request:

jobs:
  grype-scan:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ R√©cup√©ration du code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Installation de Grype (100% GRATUIT, sans token)
    - name: Install Grype
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh
        sudo mv grype /usr/local/bin/

    # 3Ô∏è‚É£ Scan complet de TOUS les fichiers du repo
    #     + G√©n√©ration TXT + JSON
    #     + Le pipeline ne peut JAMAIS √©chouer (|| true)
    - name: Run Grype Scan (Always Success)
      run: |
        mkdir -p reports

        echo "üîç Running Grype scan on the entire repository..."
        grype dir:. -o json > reports/grype-report.json || true
        grype dir:. -o table > reports/grype-report.txt || true

    # 4Ô∏è‚É£ Analyse du r√©sultat + Message OBLIGATOIRE dans les logs
    - name: Display Result Message (Mandatory)
      run: |
        if grep -q '"vulnerabilities": \[\]' reports/grype-report.json; then
          echo "‚úÖ No Vulnerability detected"
        else
          echo "‚ö†Ô∏è Vulnerability detected"
        fi

    # 5Ô∏è‚É£ Affichage du rapport TXT dans les logs
    - name: Show TXT Report in Logs
      run: |
        echo "================= GRYPE TXT REPORT ================="
        cat reports/grype-report.txt
        echo "===================================================="

    # 6Ô∏è‚É£ Upload des rapports comme artefacts t√©l√©chargeables
    - name: Upload Scan Reports
      uses: actions/upload-artifact@v4
      with:
        name: grype-vulnerability-reports
        path: reports/

    # 7Ô∏è‚É£ Forcer le statut VERT QUOI QU‚ÄôIL ARRIVE ‚úÖ
    - name: Force Green Pipeline
      run: |
        echo "‚úÖ Pipeline forced to SUCCESS for pedagogy purposes"
        exit 0
