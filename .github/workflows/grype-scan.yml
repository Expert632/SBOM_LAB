name: Grype Scan Always Green (DIR MODE)

on:
  push:
  pull_request:

jobs:
  grype-scan:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout source code
        uses: actions/checkout@v4

      - name: ✅ Install Grype (NO TOKEN)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version

      - name: ✅ Update Vulnerability Database
        run: |
          grype db update || true

      - name: ✅ Run Grype Scan (DIR MODE)
        run: |
          echo "================= START GRYPE SCAN ================="
          
          # TXT Report
          grype dir:. -o table > grype-report.txt || true
          
          # JSON Report
          grype dir:. -o json > grype-report.json || true
          
          # Display scan in LOG
          cat grype-report.txt

          echo "================= SCAN SUMMARY ================="

          # Detection logique du résultat
          if grep -q "No vulnerabilities found" grype-report.txt; then
            echo "✅ No Vulnerability detected"
          else
            echo "⚠️ Vulnerability detected"
          fi

          echo "================= END GRYPE SCAN ================="

      - name: ✅ Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: grype-reports
          path: |
            grype-report.txt
            grype-report.json
